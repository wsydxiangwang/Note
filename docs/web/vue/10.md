# props

è¿™ä¸€æ¬¡ï¼Œé€šè¿‡æºç é˜…è¯»ï¼Œä¸»è¦æ¢ç´¢çš„æ–¹é¢åŒ…æ‹¬å¦‚ä½•åˆå§‹åŒ– Propsã€ä»¥åŠå¦‚ä½•è¿›è¡Œæ›´æ–°ã€‚

## åˆå§‹åŒ–

```js
initState(vm);

function initState(vm) {
  vm._watchers = [];
  var opts = vm.$options;
  if (opts.props) { initProps(vm, opts.props); }
  // ...
}

function initProps (vm, propsOptions) {
    var propsData = vm.$options.propsData || {}; // è·å–Vueå®ä¾‹é€‰é¡¹ä¸Šçš„Props
    var props = vm._props = {}; // è·å–æŒ‚è½½Vueå®ä¾‹ä¸Šçš„_props
    var keys = vm.$options._propKeys = []; // Propsçš„Keyå€¼ç»„æˆçš„æ•°ç»„
    // ...
	for (var key in propsOptions) loop( key ); // å¾ªç¯éå† vue å®ä¾‹é€‰é¡¹ä¸­Propsï¼Œå¹¶ä¸”æ‰§è¡Œå“åº”å¼å¤„ç†ä»¥åŠæŒ‚è½½åœ¨å¯¹åº”å®ä¾‹ä¸Š
    // ...
}
```

åˆå§‹åŒ– Props çš„å…³é”®ç‚¹å°±åœ¨äºloopå‡½æ•°ï¼Œè®©æˆ‘ä»¬æ¥ç€è¯¥å‡½æ•°åšäº†ä»€ä¹ˆäº‹æƒ…ã€‚

```js
var sharedPropertyDefinition = {
  enumerable: true,
  configurable: true,
  get: noop,
  set: noop
};
function proxy (target, sourceKey, key) {
  sharedPropertyDefinition.get = function proxyGetter () {
    return this[sourceKey][key]
  };
  sharedPropertyDefinition.set = function proxySetter (val) {
    this[sourceKey][key] = val;
  };
  Object.defineProperty(target, key, sharedPropertyDefinition);
}

var loop = function ( key ) {
  keys.push(key); // æ¯éå†ä¸€æ¬¡Propsä¸­çš„å€¼ï¼Œéƒ½ä¼šæ”¶é›†å…¶Key
  // ...
  defineReactive$$1(props, key, value, function () { // å°†Vueå®ä¾‹ä¸Šå¯¹è±¡çš„_propsä¸­æ¯ä¸€é¡¹å±æ€§éƒ½è®¾ç½®å“åº”å¼
    if (!isRoot && !isUpdatingChildComponent) { // é…ç½®çš„Setterå‡½æ•°ï¼Œé¿å…å­ç»„ä»¶ç›´æ¥æ“ä½œPropsçš„è­¦å‘Š
      warn(
        "Avoid mutating a prop directly since the value will be " +
        "overwritten whenever the parent component re-renders. " +
        "Instead, use a data or computed property based on the prop's " +
        "value. Prop being mutated: \"" + key + "\"",
        vm
      );
    }
  });
  // static props are already proxied on the component's prototype
  // during Vue.extend(). We only need to proxy props defined at
  // instantiation here.
  if (!(key in vm)) { // éå†æ—¶è‹¥å‘ç°æ–°å±æ€§æ—¶ï¼Œå°±å°†æ–°å±æ€§é‡æ–°æŒ‚è½½åˆ°Vueå®ä¾‹çš„_propsä¸­
    proxy(vm, "_props", key);
  }
};
```

ç†è§£ä¸Šåº”è¯¥ä¸ä¼šæœ‰å¤ªå¤§çš„é—®é¢˜ï¼Œloopå‡½æ•°ä¸­ä¸»è¦åšäº†ä»¥ä¸‹å‡ ä»¶äº‹ï¼š

- defineReactive

ç›¸ä¿¡å¯¹è¿™ä¸ªå‡½æ•°åº”è¯¥éƒ½ä¸ä¼šé™Œç”Ÿï¼Œå…¶å®å°±æ˜¯å¯¹Vueå®ä¾‹ä¸Šçš„` _props `å¯¹è±¡ä¸­æ¯ä¸€ä¸ªå±æ€§éƒ½é…ç½®æˆå“åº”å¼çš„ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå½“çˆ¶ç»„ä»¶ä¸­ä¼ é€’è¿›æ¥çš„ `Props` å˜åŒ–æ—¶ï¼Œåˆ™ä¼šé€šçŸ¥ç›¸åº”çš„å­ç»„ä»¶ä¸­æ›´æ–°å‡½æ•°è¿›è¡Œæ›´æ–°ï¼›

- å¯¹ç›¸åº”çš„å­ç»„ä»¶é…ç½®Propså±æ€§çš„Setterè­¦å‘Šå‡½æ•°

ç”¨è¿‡Vueçš„ç«¥é‹ä»¬åº”è¯¥éƒ½ä¼šé‡åˆ°ç›´æ¥æ›´æ”¹ä¸€ä¸ª `Props` ä¸­çš„å±æ€§æ—¶ï¼Œä¼šæŠ›å‡ºä¸€ä¸ªè­¦å‘Šã€‚è€Œè¿™ä¸ªè­¦å‘Šå°±æ˜¯åœ¨ Vue éå† `_props` å¯¹è±¡ä¸­çš„å€¼æ—¶ï¼Œéƒ½ä¼šé»˜è®¤é…ç½®ä¸€ä¸ªè­¦å‘Š `Setter` å‡½æ•°ï¼›

- proxy

åœ¨éå†çš„è¿‡ç¨‹ä¸­ï¼Œä¸€æ—¦å‘ç°æœ‰æ–°çš„å±æ€§æ—¶ï¼Œéƒ½ä¼šå°†æ–°å±æ€§é‡æ–°æŒ‚è½½åˆ° Vue å®ä¾‹çš„ `_props` ä¸­ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„çŸ¥è¯†ç‚¹ï¼Œ**å½“æˆ‘ä»¬ç›´æ¥è®¿é—®ä¸€ä¸ª Props ä¸­çš„å±æ€§æ—¶ï¼Œå³ä¸Šé¢æ —å­ä¸­`this.name`ï¼Œå…¶å®æ˜¯ç›´æ¥è®¿é—®äº† Vue å®ä¾‹çš„ `_props` å¯¹è±¡ä¸­å€¼è€Œå·²ã€‚**

è‡³æ­¤ï¼Œæˆ‘ä»¬ä¹ŸçŸ¥é“ Vue æºç æ˜¯å¦‚ä½•å®ç°åˆå§‹åŒ– Props çš„äº†ï¼Œé‚£ä¹ˆï¼Œç©¶ç«Ÿæ˜¯çˆ¶ç»„ä»¶æ˜¯å¦‚ä½•é€šçŸ¥æ›´æ–° Props çš„å‘¢ï¼Ÿæˆ‘ä»¬æ¥ç€çœ‹ä¸‹å»ã€‚

## æ›´æ–°

ç”±äºçˆ¶ç»„ä»¶åœ¨æ›´æ–°çš„è¿‡ç¨‹ä¸­ï¼Œä¼šé€šçŸ¥å­ç»„ä»¶ä¹Ÿè¿›è¡Œæ›´æ–°ï¼Œè¿™æ—¶å€™å°±ä¼šè°ƒå–ä¸€ä¸ªæ–¹æ³•`updateChildComponent`ï¼Œè€Œè¿™ä¸ªæ–¹æ³•é‡Œå°±ä¼šå¯¹ `Props` è¿›è¡Œæ›´æ–°ã€‚æˆ‘ä»¬å°±æ¥çœ‹çœ‹æ˜¯å¦‚ä½•å¤„ç†çš„ï¼š

```js
updateChildComponent(
  child,
  options.propsData, // updated props
  options.listeners, // updated listeners
  vnode, // new parent vnode
  options.children // new children
);

function updateChildComponent (
 vm,
 propsData,
 listeners,
 parentVnode,
 renderChildren
) {
   // ...
   // update props
   if (propsData && vm.$options.props) {
     toggleObserving(false); // å…³é—­ä¾èµ–ç›‘å¬
     var props = vm._props; // è·å–Vueå®ä¾‹ä¸Š_propså¯¹è±¡
     var propKeys = vm.$options._propKeys || []; // è·å–ä¿ç•™åœ¨Vueå®ä¾‹ä¸Šçš„props keyå€¼
     for (var i = 0; i < propKeys.length; i++) { // å¾ªç¯éå†props key
       var key = propKeys[i];
       var propOptions = vm.$options.props; // wtf flow?
       props[key] = validateProp(key, propOptions, propsData, vm); // å…ˆæ ¡éªŒPropsä¸­å®šä¹‰çš„æ•°æ®ç±»å‹æ˜¯å¦ç¬¦åˆï¼Œç¬¦åˆçš„è¯å°±ç›´æ¥è¿”å›ï¼Œå¹¶ä¸”ç›´æ¥èµ‹å€¼ç»™Vueå®ä¾‹ä¸Š_propså¯¹è±¡ä¸­ç›¸åº”çš„å±æ€§ä¸­
     }
     toggleObserving(true); // æ‰“å¼€ä¾èµ–ç›‘å¬
     // keep a copy of raw propsData
     vm.$options.propsData = propsData; // æ–°çš„PropsDataç›´æ¥å–æ›¿æ‰é€‰é¡¹ä¸­æ—§çš„PropsData
   }
   // ...
 }
```

ä¸€å¼€å§‹çœ‹åˆ°è¿™é‡Œä»£ç æ—¶ï¼Œæˆ‘æ˜¯æ‡µé€¼çŠ¶æ€çš„ï¼Œå› ä¸ºå¾ˆå®¹æ˜“ç»•ä¸å‡ºæ¥ ğŸ˜‚ã€‚ã€‚åœ¨è¿™é‡Œé¢ä¼šæœ‰å‡ ä¸ªé—®é¢˜ï¼Œåˆ†åˆ«æ˜¯ï¼š

- validateProp ä½œç”¨ç©¶ç«Ÿæ˜¯ä»€ä¹ˆï¼Ÿ

ç›¸ä¿¡ç”¨è¿‡ Props çš„åŒå­¦éƒ½æ¸…æ¥šï¼Œåœ¨ä¼ é€’ç»™å­ç»„ä»¶æ—¶ï¼Œå­ç»„ä»¶ä¸­æ˜¯æœ‰æƒé™å†³å®šä¼ é€’çš„å€¼ç±»å‹çš„ï¼Œå¤§å¤§æé«˜ä¼ é€’çš„è§„èŒƒï¼Œä¸¾ä¸ªä¾‹å­ï¼š

```js
props: {
  name: {
    type: String,
    required: true
  }
}
```

ä»£ç å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯è§„å®š `name` å±æ€§çš„ç±»å‹ä»¥åŠæ˜¯å¦å¿…ä¼ ã€‚è€Œæ–¹æ³•`validateProp`ä½œç”¨å°±æ˜¯æ ¡éªŒçˆ¶ç»„ä»¶ä¼ é€’ç»™å­ç»„ä»¶çš„å€¼æ˜¯å¦æŒ‰è¦æ±‚ä¼ é€’ï¼Œè‹¥æ­£ç¡®ä¼ é€’åˆ™ç›´æ¥èµ‹å€¼ç»™ `_props` å¯¹è±¡ä¸Šç›¸åº”çš„å±æ€§ã€‚

- æ ¡éªŒé€šè¿‡åï¼Œç›´æ¥èµ‹å€¼ç»™ `_props` å¯¹è±¡ä¸Šç›¸åº”çš„å±æ€§çš„ç”¨æ„ä½•åœ¨ï¼Ÿ

ä¸Šé¢æåˆ°è¿‡ï¼Œ`_props` å¯¹è±¡ä¸Šçš„æ¯ä¸€ä¸ªå±æ€§éƒ½ä¼šä½¿ç”¨ `proxy` æ–¹æ³•è¿›è¡Œå“åº”å¼æŒ‚è½½ã€‚é‚£ä¹ˆå½“æˆ‘ç›´æ¥èµ‹å€¼åˆ° `_props` å¯¹è±¡ä¸Šç›¸åº”çš„å±æ€§æ—¶ï¼Œå°±ä¼šè§¦å‘åˆ°å…¶ `Setter` å‡½æ•°è¿›è¡Œç›¸åº”çš„ä¾èµ–æ›´æ–°ã€‚å› æ­¤ï¼Œå½“çˆ¶ç»„ä»¶æ›´æ–°ä¸€ä¸ªä¼ é€’åˆ°å­ç»„ä»¶çš„å±æ€§æ—¶ï¼Œé¦–å…ˆä¼šè§¦å‘å…¶ `Setter` å‡½æ•°é€šçŸ¥çˆ¶ç»„ä»¶è¿›è¡Œæ›´æ–°ï¼Œç„¶åé€šè¿‡æ¸²æŸ“å‡½æ•°ä¼ é€’åˆ°å­ç»„ä»¶åï¼Œæ›´æ–°å­ç»„ä»¶ä¸­çš„ `Props`ã€‚è¿™æ—¶å€™ï¼Œç”±äºæ­¤æ—¶çš„ `Props` å¯¹è±¡ä¸­çš„å±æ€§æ”¶é›†åˆ°äº†å­ç»„ä»¶çš„ä¾èµ–ï¼Œæ›´æ”¹åä¼šé€šçŸ¥ç›¸åº”çš„ä¾èµ–è¿›è¡Œæ›´æ–°ã€‚

- toggleObserving ç©¶ç«Ÿæ˜¯å¹²å˜›ç”¨çš„ï¼Ÿ

é¦–å…ˆå®ƒæ˜¯ä¸€ä¸ªé€’å½’éå†æ–¹æ³•ï¼Œ**`Props` åœ¨é€šçŸ¥å­ç»„ä»¶ä¾èµ–æ›´æ–°æ—¶ï¼Œå¿…é¡»ææ¸…æ¥šçš„ä¸€ç‚¹ï¼Œå°±æ˜¯æ˜¯æ•´ä¸ªå€¼çš„å˜åŒ–æ¥è¿›è¡Œé€šçŸ¥**ã€‚å¦‚ä½•ç†è§£ï¼Ÿ

ç®€å•æ»´è¯´ï¼Œå¯¹äºå±æ€§å€¼ä¸ºåŸºæœ¬æ•°æ®ç±»å‹çš„ï¼Œå½“å€¼æ”¹å˜æ—¶ï¼Œæ˜¯å¯ä»¥ç›´æ¥é€šçŸ¥å­ç»„ä»¶è¿›è¡Œæ›´æ–°çš„ï¼Œè€Œå¯¹äºå¤æ‚æ•°æ®ç±»å‹æ¥è¯´ï¼Œåœ¨æ›´æ–°æ—¶ï¼Œä¼šé€’å½’éå†å…¶å¯¹è±¡å†…éƒ¨çš„å±æ€§æ¥é€šçŸ¥ç›¸åº”çš„ä¾èµ–è¿›è¡Œæ›´æ–°ã€‚

é‚£ä¹ˆå½“è°ƒç”¨æ–¹æ³•`toggleObserving`ä¸º false æ—¶ï¼Œå¯¹äºåŸºç¡€æ•°æ®ç±»å‹æ¥è¯´ï¼Œå½“å…¶å€¼å˜åŒ–æ—¶åˆ™ç›´æ¥é€šçŸ¥å­ç»„ä»¶æ›´æ–°ï¼Œè€Œå¯¹äºå…¶å¤æ‚æ•°æ®ç±»å‹æ¥è¯´ï¼Œåˆ™ä¸ä¼šé€’å½’ä¸‹å»ï¼Œè€Œåªä¼šç›‘å¬æ•´ä¸ªå¤æ‚æ•°æ®ç±»å‹æ›¿æ¢æ—¶ï¼Œæ‰ä¼šå»é€šçŸ¥å­ç»„ä»¶è¿›è¡Œæ›´æ–°ã€‚å› æ­¤åœ¨ `Props` ä¸­æ‰€æœ‰å±æ€§é€šçŸ¥å®Œåï¼Œåˆä¼šé‡æ–°è°ƒç”¨æ–¹æ³•toggleObservingä¸º true æ¥æ‰“å¼€é€’å½’å¼€å…³ã€‚ï¼ˆçœŸçš„ä¸å¾—ä¸æœå°¤å¤§å¤§å•Šï¼Œè¿™ä¹ˆå¥½çš„ä¼˜åŒ–æ€è·¯éƒ½èƒ½æƒ³å‡ºæ¥ï¼Œç‰›äºº ğŸ‘ï¼‰


è‡³æ­¤ï¼Œä½ å¤§æ¦‚ä¹ŸçŸ¥é“æ•´ä¸ªæ›´æ–°æµç¨‹äº†ï¼Œä½†æ˜¯æˆ‘å½“æ—¶è¿˜æ˜¯å­˜åœ¨ç–‘æƒ‘çš„ï¼Œæ—¢ç„¶åŸºç¡€æ•°æ®ç±»å‹å€¼æ›´æ”¹æˆ–å¤æ‚æ•°æ®ç±»å‹æ•´ä¸ªå€¼æ›´æ”¹ï¼Œå¯ä»¥ç›´æ¥é€šçŸ¥åˆ°å­ç»„ä»¶è¿›è¡Œæ›´æ–°ï¼Œé‚£ä¹ˆæ˜¯å¦ä¼šæœ‰ä¸€ç§æƒ…å†µå°±æ˜¯ï¼Œå¤æ‚æ•°æ®ç±»å‹ä¸­å±æ€§æ›´æ”¹æ—¶ï¼Œåˆæ˜¯å¦‚ä½•é€šçŸ¥å­ç»„ä»¶æ›´æ–°çš„å‘¢ï¼Ÿï¼ŸğŸ¤”


é¦–å…ˆï¼Œæˆ‘ä»¬ä¸€å¼€å§‹å·²ç»å¿½ç•¥ä¸€ä¸ªæ–¹æ³•ï¼Œé‚£å°±æ˜¯defineReactive$$1ï¼Œè¿™ä¸ªæ–¹æ³•çœŸçš„ç”¨çš„ç§’ï¼Œå¯ä»¥çœ‹çœ‹ä¸Šé¢çš„ä»£ç ï¼Œåœ¨åˆå§‹åŒ– Props æ—¶å€™ï¼Œä¼šå¯¹ Props æ¯ä¸€é¡¹çš„å±æ€§è¿›è¡Œä½¿ç”¨è¯¥æ–¹æ³•è¿›è¡Œå“åº”å¼çš„å¤„ç†ï¼ŒåŒ…æ‹¬äº†å¤æ‚æ•°æ®ç±»å‹çš„ä¸­å±æ€§ï¼Œæ­¤æ—¶è¯¥å±æ€§ä¸ä½†æ”¶é›†äº†çˆ¶ç»„ä»¶ä¾èµ–ï¼Œè¿˜æ”¶é›†äº†å­ç»„ä»¶çš„ä¾èµ–ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå½“å¤æ‚æ•°æ®ç±»å‹ä¸­å±æ€§å˜åŒ–æ—¶ï¼Œä¼šå…ˆé€šçŸ¥çˆ¶ç»„ä»¶æ›´æ–°ï¼Œå†é€šçŸ¥å­ç»„ä»¶è¿›è¡Œæ›´æ–°ã€‚ï¼ˆè¿™æ—¶å€™æˆ‘çœŸçš„ä¸å¾—ä¸æœåˆ°äº”ä½“æŠ•åœ°ã€‚ã€‚ã€‚ï¼‰

## æ€»ç»“

- å½“ Props ä¸­å±æ€§ä¸ºåŸºç¡€æ•°æ®ç±»å‹å€¼æ›´æ”¹æˆ–å¤æ‚æ•°æ®ç±»å‹æ›¿æ¢æ—¶ï¼Œä¼šé€šè¿‡ Setter å‡½æ•°é€šçŸ¥çˆ¶ç»„ä»¶è¿›è¡Œæ›´æ–°ï¼Œç„¶åé€šè¿‡æ¸²æŸ“å‡½æ•°ï¼Œä¼ é€’åˆ°å­ç»„ä»¶ä¸­æ›´æ–°å…¶ Props ä¸­å¯¹è±¡ç›¸åº”çš„å€¼ï¼Œè¿™æ—¶å€™å°±ä¼šè§¦å‘åˆ°ç›¸åº”å€¼çš„ Setter æ¥é€šçŸ¥å­ç»„ä»¶è¿›è¡Œæ›´æ–°ï¼›
- å½“ Props ä¸­å±æ€§ä¸ºå¤æ‚æ•°æ®ç±»å‹çš„å±æ€§æ›´æ”¹æ—¶ï¼Œç”±äºä½¿ç”¨defineReactive$$1æ–¹æ³•æ”¶é›†åˆ°äº†çˆ¶ç»„ä»¶ä¾èµ–ä»¥åŠå­ç»„ä»¶çš„ä¾èµ–ï¼Œè¿™æ—¶å€™ä¼šå…ˆé€šçŸ¥çˆ¶ç»„ä»¶è¿›è¡Œæ›´æ–°ï¼Œå†é€šçŸ¥å­ç»„ä»¶è¿›è¡Œæ›´æ–°ï¼›


å‚è€ƒ:

- [Vue.js æŠ€æœ¯æ­ç§˜ props](https://ustbhuangyi.github.io/vue-analysis/v2/reactive/props.html)
- [ã€ Vue æºç åˆ†æ ã€‘è¿è¡Œæœºåˆ¶ä¹‹ Props](https://github.com/Andraw-lin/about-Vue/blob/master/docs/%E3%80%90%20Vue%20%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%20%E3%80%91%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6%E4%B9%8B%20Props.md)